<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Imbalance Monitor</title>
    <link rel="icon" type="image/png" href="./img/fv.png" />
    <style>
      :root {
        --bg: #f4f4f4;
        --text: #000;
        --table-bg: #fff;
        --header-bg: #ccc;
        --alert-text: red;

        --fs-base: clamp(12px, 1.6vw + 8px, 16px);
        --fs-h1: clamp(18px, 2vw + 14px, 26px);
        --fs-h2: clamp(16px, 1.6vw + 12px, 20px);
      }
      body {
        font-size: var(--fs-base);
      }
      h1 {
        font-size: var(--fs-h1);
      }
      h2 {
        font-size: var(--fs-h2);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        background: var(--bg);
        color: var(--text);
        transition: background 0.3s, color 0.3s;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        align-items: center;
        padding: 1rem;
      }
      h1,
      h2 {
        margin: 0.3rem 0;
      }
      button {
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 1rem;
        cursor: pointer;
      }
      .tables {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: calc(100vh - 100px);
        padding: 0 1rem 1rem 1rem;
        box-sizing: border-box;
      }
      @media (min-width: 900px) {
        .tables {
          flex-direction: row;
        }
      }
      .table-container {
        flex: 1;
        background: var(--table-bg);
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        border: 2px solid var(--header-bg);
        position: relative;
        height: 100%;
      }
      .table-container h2 {
        position: sticky;
        top: 0;
        background: var(--table-bg);
        z-index: 2;
        padding: 4px 0;
        margin: 0;
        font-size: 1.2rem;
        color: green;
      }
      .table-container#sell h2 {
        color: red;
      }
      .table-content {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
        /* —â–æ–± –ø—Ä–∏ –ø–æ—è–≤—ñ/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—ñ —Å–∫—Ä–æ–ª—É —à–∏—Ä–∏–Ω–∞ –Ω–µ —Å—Ç—Ä–∏–±–∞–ª–∞ */
        scrollbar-gutter: stable both-edges;
      }

      .main-table {
        border-collapse: collapse;
        table-layout: fixed;
        min-width: 420px; /* üëà –≥–æ–ª–æ–≤–Ω–µ ‚Äì –Ω–µ —Å—Ç–∏—Å–∫–∞—î–º–æ –º–µ–Ω—à–µ 420px */
        width: auto; /* üëà –Ω–µ –ø—ñ–¥–≥–∞–Ω—è—î–º–æ –ø—ñ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
      }
      /* –ê—Ä—Ö—ñ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è ‚Äî —Å–≤–æ—è,
      –∫–æ–º–ø–∞–∫—Ç–Ω–∞,
      –Ω–µ –ª–∞–º–∞—î –º–∞–∫–µ—Ç */
      .archive-table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
        font-size: 0.9em;
      }

      .archive-table th,
      .archive-table td {
        padding: 3px 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞—Ä—Ö—ñ–≤—É –º–æ–∂–µ —Å–∫—Ä–æ–ª–∏—Ç–∏—Å—å –æ–∫—Ä–µ–º–æ —ñ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ, —ñ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ */
      .archive-scroll {
        max-height: 260px;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #aaa;
        margin-top: 5px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background: #fff;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background: #9bbedb;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      th,
      td {
        border: 2px solid var(--header-bg);
        padding: 8px;
        text-align: center;
      }
      th {
        background: var(--header-bg);
        cursor: pointer;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      tr.high-imbalance td,
      tr.dashed-symbol td {
        color: var(--alert-text);
        font-weight: bold;
      }
      .archive-row.hidden {
        display: none;
      }
      tr.buy-leader td {
        background: #d3f9d8;
      }
      tr.sell-leader td {
        background: #ffd6d6;
      }
      tr.flash-change {
        animation: flash 1s ease-in-out;
      }
      @keyframes flash {
        from {
          background: #ffff99;
        }
        to {
          background: transparent;
        }
      }
      a.finviz-link {
        text-decoration: none;
        color: inherit;
      }
      .archive-scroll {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #aaa;
        margin-top: 5px;
      }
      .table-content.updating {
        opacity: 0.5;
        transition: opacity 2s ease;
      }
      [data-theme="dark"] {
        --bg: #111;
        --text: #fff;
        --table-bg: #222;
        --header-bg: #333;
        --alert-text: lightcoral;
      }

      /* ===== Login card ===== */
      #login,
      #app {
        display: none;
      }
      .center {
        min-height: 100dvh;
        display: grid;
        place-items: center;
      }
      .card {
        width: 360px;
        max-width: 92vw;
        background: #131b2e;
        color: #e6e9ef;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      }
      .card h1 {
        margin: 0 0 12px;
        font-size: 22px;
      }
      .card label {
        display: block;
        margin: 14px 0 6px;
        font-size: 13px;
        color: #b7c0d5;
      }
      .card input {
        width: 92%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #2b3550;
        background: #0e1526;
        color: #e6e9ef;
      }
      .card button {
        width: 100%;
        padding: 12px;
        border: 0;
        border-radius: 10px;
        margin-top: 16px;
        font-weight: 600;
        cursor: pointer;
        background: #2f6fed;
        color: #fff;
      }
      .muted {
        color: #9aabc7;
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
      }
      .load {
        text-align: center;
      }
      .msg {
        min-height: 22px;
        margin-top: 10px;
        font-size: 13px;
        color: #ffb4b4;
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 8px;
        border-bottom: 3px solid #223;
      }
      .topbar .right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .pill {
        padding: 6px 10px;
        color: rgb(68, 106, 230);
        border-radius: 999px;
        border: 2px solid #4d5877;
      }

      /* ===== Mobile responsiveness improvements ===== */

      /* –ë–∞–∑–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä–∏ —à—Ä–∏—Ñ—Ç—ñ–≤ —á–µ—Ä–µ–∑ clamp */
      html,
      body {
        font-size: clamp(12px, 1.4vw + 0.3rem, 16px);
      }
      h1 {
        font-size: clamp(18px, 2.2vw + 0.8rem, 26px);
      }
      h2 {
        font-size: clamp(14px, 1.8vw + 0.5rem, 20px);
      }

      /* –†–æ–±–∏–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—å —â–µ –π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ —Å–∫—Ä–æ–ª—å–Ω–∏–º */
      .table-content {
        overflow-y: auto;
        overflow-x: auto; /* + */
      }

      /* –¢—Ä–æ—Ö–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö */
      @media (max-width: 900px) {
        .controls {
          gap: 0.6rem;
        }
        .controls h1 {
          margin-bottom: 0.2rem;
        }
        .table-container {
          padding: 0.75rem;
        }
        th,
        td {
          padding: 6px;
        }
      }

      /* –º–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è */
      @media (max-width: 600px) {
        .main-table {
          width: 100%;
          table-layout: fixed;
          font-size: 12px;
        }
        .main-table th,
        .main-table td {
          padding: 3px 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        /* Update Time */
        .main-table th:nth-child(1),
        .main-table td:nth-child(1) {
          max-width: 55px;
        }

        /* Symbol */
        .main-table th:nth-child(2),
        .main-table td:nth-child(2) {
          max-width: 95px;
        }

        /* Imbalance */
        .main-table th:nth-child(3),
        .main-table td:nth-child(3) {
          max-width: 85px;
        }

        /* Paired ‚Äî —Ö–æ–≤–∞—î–º–æ */
        .main-table th:nth-child(4),
        .main-table td:nth-child(4) {
          display: none;
        }

        /* ADV ‚Äî —Ö–æ–≤–∞—î–º–æ */
        .main-table th:nth-child(5),
        .main-table td:nth-child(5) {
          display: none;
        }

        /* %ImbADV */
        .main-table th:nth-child(6),
        .main-table td:nth-child(6) {
          max-width: 55px;
        }

        /* Finviz link ‚Äî —Ö–æ–≤–∞—î–º–æ */
        a.finviz-link {
          display: none;
        }
      }

      /* –ï–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –≤—É–∑—å–∫–æ ‚Äî —Ö–æ–≤–∞—î–º–æ –¥—Ä—É–≥–æ—Ä—è–¥–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏, –ª–∏—à–∞—î–º–æ –≥–æ–ª–æ–≤–Ω–µ
   –ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ —É —Ç–µ–±–µ: 
   1) Update Time  2) Symbol  3) Imbalance  4) Paired  5) ADV  6) % ImbADV
*/
      @media (max-width: 480px) {
        /* —Å—Ö–æ–≤–∞—Ç–∏ Paired —ñ ADV */
        .main-table th:nth-child(4),
        .main-table td:nth-child(4),
        .main-table th:nth-child(5),
        .main-table td:nth-child(5) {
          display: none;
        }
      }

      /* –©–µ –≤—É–∂—á–µ ‚Äî —è–∫—â–æ –¥—É–∂–µ —Ç—Ä–µ–±–∞, –º–æ–∂–Ω–∞ —Å—Ö–æ–≤–∞—Ç–∏ Update Time */
      @media (max-width: 360px) {
        .main-table th:nth-child(1),
        .main-table td:nth-child(1) {
          display: none;
        }
      }

      /* –ü—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è –ø—ñ–¥—Å–≤—ñ—á–µ–Ω–æ–≥–æ –ø–æ—à—É–∫–æ–º —Ä—è–¥–∫–∞, –∞–ª–µ –±–µ–∑ ‚Äú—è—Å–∫—Ä–∞–≤–æ—ó –∑–∞–ª–∏–≤–∫–∏‚Äù */
      .tables .table-content table tbody tr.expand-row td:nth-child(2) {
        transition: background-color 0.2s, outline-color 0.2s;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <section id="login" class="center">
      <div class="card">
        <h1>–í—Ö—ñ–¥</h1>
        <form id="loginForm">
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="username" required />
          <label for="password">–ü–∞—Ä–æ–ª—å</label>
          <input id="password" type="password" autocomplete="current-password" required />
          <button type="submit">–£–≤—ñ–π—Ç–∏</button>
          <div id="msg" class="msg"></div>
          <div class="muted">–î–æ—Å—Ç—É–ø –≤–∏–¥–∞—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä.</div>
        </form>
      </div>
    </section>

    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶ -->
    <section id="loading" class="center" style="display: none">
      <div class="card">
        <h1 class="load">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</h1>
        <div class="muted">–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø</div>
      </div>
    </section>

    <!-- APP (—Ç–≤–æ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞) -->
    <section id="app">
      <div class="topbar">
        <div class="left">üîí Private Trading Page</div>
        <div class="right">
          <span id="who" class="pill"></span>
          <button id="signout" class="pill">‚Ü©Ô∏è Log out</button>
        </div>
      </div>

      <div class="controls">
        <h1>üìä Imbalance Monitor</h1>
        <input
          type="text"
          id="search-symbol"
          placeholder="üîç Search..."
          style="
            padding: 6px 3px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
          " />
        <div id="last-update" style="font-weight: bold">
          Last update: <span id="update-time">‚Äî</span>
        </div>
        <label class="switch">
          <input type="checkbox" id="themeToggle" onclick="toggleTheme()" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="tables">
        <div class="table-container" id="buy">
          <h2>Buy Imbalance (<span id="buy-count">0</span>)</h2>
          <div class="table-content">üì≠ Data is currently unavailable</div>
        </div>
        <div class="table-container" id="sell">
          <h2>Sell Imbalance (<span id="sell-count">0</span>)</h2>
          <div class="table-content">üì≠ Data is currently unavailable</div>
        </div>
      </div>
    </section>

    <!-- ======= Firebase (auth) ======= -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // ==========================
      //      UI / TABLE LOGIC
      // ==========================

      let theme = localStorage.getItem("theme") || "light";

      function applyTheme() {
        const r = document.documentElement;
        r.setAttribute("data-theme", theme);
        if (theme === "dark") {
          r.style.setProperty("--bg", "#111");
          r.style.setProperty("--text", "#fff");
          r.style.setProperty("--table-bg", "#222");
          r.style.setProperty("--header-bg", "#333");
          r.style.setProperty("--alert-text", "lightcoral");
        } else {
          r.style.setProperty("--bg", "#f4f4f4");
          r.style.setProperty("--text", "#000");
          r.style.setProperty("--table-bg", "#fff");
          r.style.setProperty("--header-bg", "#ccc");
          r.style.setProperty("--alert-text", "red");
        }
      }

      function toggleTheme() {
        theme = theme === "dark" ? "light" : "dark";
        localStorage.setItem("theme", theme);
        applyTheme();
      }

      function saveSortState(id, col, desc) {
        localStorage.setItem(`sort_${id}`, JSON.stringify({ col, desc }));
      }

      function getSortState(id) {
        const s = localStorage.getItem(`sort_${id}`);
        return s ? JSON.parse(s) : null;
      }

      function sortTable(table, colIndex, forceDesc = null) {
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (r) => !r.classList.contains("archive-row") && !r.closest(".archive-table")
        );

        const tableId = table.closest(".table-container")?.id || "default";
        const state = getSortState(tableId);
        let desc =
          forceDesc !== null ? forceDesc : state?.col === colIndex ? !state.desc : true;

        rows.sort((a, b) => {
          const aSymbol = a.dataset.symbol || "";
          const bSymbol = b.dataset.symbol || "";

          const aPercent =
            parseFloat(a.children[colIndex].innerText.replace(/[^0-9.\-]/g, "")) || 0;
          const bPercent =
            parseFloat(b.children[colIndex].innerText.replace(/[^0-9.\-]/g, "")) || 0;

          const aIsDash = aSymbol.includes("-");
          const bIsDash = bSymbol.includes("-");
          const aIsHigh = aPercent >= 95;
          const bIsHigh = bPercent >= 95;

          if (aIsHigh !== bIsHigh) return desc ? (bIsHigh ? 1 : -1) : aIsHigh ? 1 : -1;
          if (aIsDash !== bIsDash) return desc ? (bIsDash ? 1 : -1) : aIsDash ? 1 : -1;
          return desc ? bPercent - aPercent : aPercent - bPercent;
        });

        rows.forEach((row) => {
          const archiveRow = row.nextElementSibling?.classList.contains("archive-row")
            ? row.nextElementSibling
            : null;
          tbody.appendChild(row);
          if (archiveRow) tbody.appendChild(archiveRow);
        });

        saveSortState(tableId, colIndex, desc);
      }

      let lastSearch = "";
      let expandedSymbols = new Set();
      let scrollPositions = {};

      function saveUIState() {
        const searchEl = document.getElementById("search-symbol");
        lastSearch = searchEl ? searchEl.value.trim().toUpperCase() : "";

        expandedSymbols.clear();
        document.querySelectorAll(".expand-row").forEach((row) => {
          const next = row.nextElementSibling;
          if (next && !next.classList.contains("hidden")) {
            expandedSymbols.add(row.dataset.symbol);
          }
        });

        scrollPositions = {};
        document.querySelectorAll(".table-content").forEach((c) => {
          scrollPositions[c.id] = c.scrollTop;
        });
      }

      function restoreUIState() {
        // search text back
        const input = document.getElementById("search-symbol");
        if (input) {
          input.value = lastSearch;
          input.dispatchEvent(new Event("input"));
        }

        // reopen expanded archives
        document.querySelectorAll(".expand-row").forEach((row) => {
          if (expandedSymbols.has(row.dataset.symbol)) {
            const next = row.nextElementSibling;
            if (next && next.classList.contains("archive-row")) {
              next.classList.remove("hidden");
              row.classList.add("expanded");
            }
          }
        });

        // restore scroll
        for (const [id, top] of Object.entries(scrollPositions)) {
          const c = document.getElementById(id);
          if (c) c.scrollTop = top;
        }
      }

      async function loadTable(json, id) {
        // robust fetch with fallback message instead of throwing
        let data;
        try {
          const res = await fetch(json + "?t=" + new Date().getTime(), {
            cache: "no-store",
          });
          if (!res.ok) throw new Error("HTTP " + res.status);

          const txt = await res.text();
          if (!txt || !txt.trim().startsWith("{")) throw new Error("empty/bad json");

          data = JSON.parse(txt);
          if (!data || !data.main) throw new Error("bad shape");
        } catch (err) {
          console.warn("loadTable fail for", json, err);
          const container = document.querySelector(`#${id} .table-content`);
          if (container) {
            container.innerText = "üì≠ Data is currently unavailable";
          }
          const countEl = document.getElementById(`${id}-count`);
          if (countEl) countEl.textContent = "0";
          return;
        }

        const container = document.querySelector(`#${id} .table-content`);
        if (!container) return;

        const countEl = document.getElementById(`${id}-count`);
        if (countEl) {
          countEl.textContent = data.main.length > 1 ? data.main.length - 1 : 0;
        }

        if (!data.main || data.main.length <= 1) {
          container.innerText = "üì≠ Data is currently unavailable";
          return;
        }

        // build main table
        let html = '<table class="main-table"><thead><tr>';
        data.main[0].forEach((cell, i) => {
          html += `<th onclick="sortTable(this.closest('table'), ${i})">${cell}</th>`;
        });
        html += "</tr></thead><tbody>";

        for (let i = 1; i < data.main.length; i++) {
          const row = data.main[i];
          const symbol = row[1];
          const percent = parseFloat(row[row.length - 1].replace("%", "")) || 0;

          const rowHasDash = symbol.includes("-");
          const isHighImb = percent >= 95;

          let rowStyle = "";
          if (rowHasDash) {
            rowStyle = "background-color:#c39005;color:white;";
          } else if (isHighImb) {
            rowStyle = "background-color:#007366;color:white;";
          }

          const cleanSymbol = symbol.replace(/\s*\(PR\)\s*$/, "").replace(/-+$/, "");

          const finvizLink = `<a class="finviz-link" href="https://finviz.com/quote.ashx?t=${cleanSymbol}&p=d" target="_blank" title="–í—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–∞ Finviz">üîó</a>`;

          html += `<tr class="expand-row" data-symbol="${symbol}" style="${rowStyle}">`;

          // archive lookup key
          const lookupSymbol = cleanSymbol;
          const archive = data.archive?.[lookupSymbol];

          // flip marker if both BUY and SELL appeared in history
          let flipMarker = "";
          if (archive) {
            const sides = new Set();
            for (const entry of archive.slice(1)) {
              const sideVal = (entry[1] || "").toUpperCase();
              if (sideVal === "BUY" || sideVal === "SELL") {
                sides.add(sideVal);
              }
            }
            if (sides.has("BUY") && sides.has("SELL")) {
              flipMarker = " üü¢‚ÜîÔ∏èüî¥";
            }
          }

          row.forEach((cell, idx2) => {
            let formatted =
              idx2 >= 2 && idx2 <= 4 && !isNaN(cell)
                ? Number(cell).toLocaleString()
                : cell;

            if (idx2 === 1) {
              formatted = `${cell}${flipMarker} ${finvizLink}`;
            }
            html += `<td>${formatted}</td>`;
          });

          html += "</tr>";

          if (archive) {
            html += `<tr class="archive-row hidden"><td colspan="${row.length}">
          <div class="archive-scroll">
          <table class="archive-table">
            <thead><tr>`;

            archive[0].forEach((c) => {
              html += `<th>${c}</th>`;
            });

            html += `</tr></thead><tbody>`;

            const archiveData = archive.slice(1).sort((a, b) => b[0].localeCompare(a[0]));

            archiveData.forEach((r) => {
              html += "<tr>";
              r.forEach((c, idx3) => {
                let formatted = c;

                if ((idx3 === 2 || idx3 === 3) && !isNaN(c)) {
                  formatted = Number(c).toLocaleString();
                }

                if (idx3 === 1 && typeof c === "string") {
                  const v = c.trim().toUpperCase();
                  if (v === "BUY") formatted = "üü¢ Buy";
                  if (v === "SELL") formatted = "üî¥ Sell";
                }

                html += `<td>${formatted}</td>`;
              });
              html += "</tr>";
            });

            html += `</tbody></table></div></td></tr>`;
          }
        }

        html += "</tbody></table>";
        container.innerHTML = html;

        // click row ‚Üí toggle archive
        document.querySelectorAll(`#${id} .expand-row`).forEach((rowEl) => {
          rowEl.addEventListener("click", (e) => {
            const td = e.target.closest("td");
            const idxClicked = Array.from(rowEl.children).indexOf(td);

            const clickedLink = e.target.closest("a");
            if (idxClicked === 1 || clickedLink) {
              return;
            }

            const next = rowEl.nextElementSibling;
            if (next && next.classList.contains("archive-row")) {
              next.classList.toggle("hidden");
              rowEl.classList.toggle("expanded");
            }
          });
        });

        // restore sort priority
        const table = container.querySelector("table");
        const saved = getSortState(id);
        if (saved) {
          sortTable(table, saved.col, saved.desc);
        } else {
          const lastCol = data.main[0].length - 1;
          sortTable(table, lastCol, true);
        }
      }

      async function loadAll() {
        saveUIState();

        document
          .querySelectorAll(".table-content")
          .forEach((c) => c.classList.add("updating"));

        await Promise.all([
          loadTable("data_json/buy_data.json", "buy"),
          loadTable("data_json/sell_data.json", "sell"),
        ]);

        setTimeout(() => {
          document
            .querySelectorAll(".table-content")
            .forEach((c) => c.classList.remove("updating"));
          restoreUIState();
        }, 100);
      }

      function updateTimestamp() {
        const el = document.getElementById("update-time");
        const now = new Date();
        const formatted = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
        if (el) el.textContent = formatted;
      }

      function initAppUI() {
        applyTheme();
        loadAll();
        updateTimestamp();

        // periodic refresh
        setInterval(() => {
          requestAnimationFrame(() => {
            updateTimestamp();
            loadAll();
          });
        }, 20000);

        // live search
        const searchInput = document.getElementById("search-symbol");
        if (searchInput) {
          searchInput.addEventListener("input", function () {
            const search = this.value.trim().toUpperCase();
            document
              .querySelectorAll(".tables .table-content table tbody tr.expand-row")
              .forEach((row) => {
                const cell = row.querySelector("td:nth-child(2)");
                if (!cell) return;

                const text = cell.textContent.toUpperCase();
                const match = text.includes(search);

                row.style.display = match ? "" : "none";

                const archive = row.nextElementSibling;
                if (archive && archive.classList.contains("archive-row")) {
                  archive.style.display = match ? "" : "none";
                }

                cell.style.fontWeight = match && search !== "" ? "bold" : "";
                cell.style.background = match && search !== "" ? "#57abf4" : "";
              });
          });
        }
      }

      // =========================================
      //    AUTH / SESSION LOCK / AUTO-LOGOUT
      // =========================================

      // ================== CONFIG ==================
      const firebaseConfig = {
        apiKey: "AIzaSyBIQ06AVmsPc1i1gbq2YlQtVcgvMD9akSA",
        authDomain: "imbalance-monitor.firebaseapp.com",
        projectId: "imbalance-monitor",
        storageBucket: "imbalance-monitor.firebasestorage.app",
        messagingSenderId: "731994156123",
        appId: "1:731994156123:web:46f8ff25c8baffe9d2237e",
        measurementId: "G-M5WYYMS3T7",
      };

      firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const functions = firebase.functions();
      const db = firebase.firestore();

      // ================== CLIENT ID ==================
      // —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä —Å–∞–º–µ –¶–¨–û–ì–û –±—Ä–∞—É–∑–µ—Ä–∞
      function getClientId() {
        let cid = localStorage.getItem("imbalance_client_id");
        if (!cid) {
          cid = "c_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
          localStorage.setItem("imbalance_client_id", cid);
        }
        return cid;
      }
      const CLIENT_ID = getClientId();

      // ================== DOM refs ==================
      const elApp = document.getElementById("app");
      const elLogin = document.getElementById("login");
      const elLoading = document.getElementById("loading");
      const elForm = document.getElementById("loginForm");
      const elMsg = document.getElementById("msg");
      const elWho = document.getElementById("who");
      const elOut = document.getElementById("signout");

      // ================== STATE ==================
      let appReady = false;
      let currentUid = null;
      let lastUserActionTs = Date.now();

      // –ø—Ä–æ–¥ = 2 –≥–æ–¥–∏–Ω–∏; –º–æ–∂–µ—à –∑–º–µ–Ω—à–∏—Ç–∏ –Ω–∞ —Ç–µ—Å—Ç
      const AUTO_LOGOUT_IDLE = 2 * 60 * 60 * 1000;
      // const AUTO_LOGOUT_IDLE = 2 * 60 * 1000;

      let heartbeatTimer = null;
      let idleTimer = null;

      // ================== SMALL HELPERS (UI) ==================
      function showLogin() {
        elLogin.style.display = "grid";
        elLoading.style.display = "none";
        elApp.style.display = "none";
      }

      function showLoading() {
        elLogin.style.display = "none";
        elLoading.style.display = "grid";
        elApp.style.display = "none";
      }

      function showApp(email) {
        elWho.textContent = email || "User";
        elLogin.style.display = "none";
        elLoading.style.display = "none";
        elApp.style.display = "block";
      }

      // ================== SERVER CALLS ==================
      async function callAcquireSession({ resume }) {
        const fn = functions.httpsCallable("acquireSessionIfFree");
        const res = await fn({ clientId: CLIENT_ID, resume: !!resume });
        return res.data;
      }

      async function callHeartbeat() {
        const fn = functions.httpsCallable("heartbeat");
        return fn({ clientId: CLIENT_ID })
          .then(() => {})
          .catch(() => {});
      }

      async function callReleaseSession() {
        const fn = functions.httpsCallable("releaseSession");
        try {
          await fn();
        } catch (_) {}
      }

      function sendBeaconRelease(uid) {
        if (!uid) return;
        try {
          const blob = new Blob([JSON.stringify({ uid, clientId: CLIENT_ID })], {
            type: "application/json",
          });
          navigator.sendBeacon(
            "https://us-central1-imbalance-monitor.cloudfunctions.net/releaseSessionBeacon",
            blob
          );
        } catch (_) {}
      }

      // ================== LOGOUT FLOW ==================
      function cleanupClientTimers() {
        if (heartbeatTimer) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
        }
        if (idleTimer) {
          clearInterval(idleTimer);
          idleTimer = null;
        }
      }

      async function logoutAndRelease({ viaBeacon = false } = {}) {
        try {
          if (viaBeacon) {
            sendBeaconRelease(currentUid);
          } else {
            await callReleaseSession();
          }
        } catch (_) {}

        try {
          await auth.signOut();
        } catch (_) {}

        cleanupClientTimers();
        appReady = false;
        currentUid = null;
        showLogin();
      }

      // ================== SESSION KEEP-ALIVE ==================
      function startHeartbeatLoop() {
        heartbeatTimer = setInterval(() => {
          callHeartbeat().then((res) => {
            // –æ–ø—Ü—ñ–π–Ω–æ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —ñ –∫—ñ–∫–∞—Ç–∏, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–µ "taken-by-other"
          });
        }, 30 * 1000);
      }

      function startIdleLogoutWatch() {
        ["click", "mousemove", "keydown", "touchstart", "scroll"].forEach((ev) => {
          window.addEventListener(ev, () => {
            lastUserActionTs = Date.now();
          });
        });

        idleTimer = setInterval(() => {
          const idleFor = Date.now() - lastUserActionTs;
          if (idleFor > AUTO_LOGOUT_IDLE) {
            logoutAndRelease({ viaBeacon: false });
          }
        }, 5000);
      }

      // –≤–∞–∂–ª–∏–≤–æ: –Ω–∞ reload Safari —Ç–µ–∂ –≤–∏–∫–ª–∏–∫–∞—î beforeunload.
      // –¢–µ–ø–µ—Ä –º–∏ –ù–ï —Ä—É–±–∞—î–º–æ active=false, –º–∏ –ª–∏—à–µ —à–ª–µ–º–æ beacon –∑ uid+clientId,
      // backend –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–∏—Ç—å lastSeenAt. –¶–µ –Ω–µ –∑–Ω–∏—â—É—î —Å–µ—Å—ñ—é.
      window.addEventListener("beforeunload", () => {
        sendBeaconRelease(currentUid);
      });

      // ================== —Ç–≤—ñ–π UI –¥–ª—è —Ç–∞–±–ª–∏—Ü—å ==================
      function bootDataUI() {
        if (appReady) {
          initAppUI();
        }
      }

      // ================== AUTH LISTENER ==================
      auth.onAuthStateChanged(async (user) => {
        cleanupClientTimers(); // —Å–∫–∏–¥–∞—î–º–æ –ª—É–ø–∏, —â–æ–± –Ω–µ –±—É–ª–æ –¥—É–±–ª—ñ–≤

        if (!user) {
          // —é–∑–µ—Ä –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π –≤ Firebase
          appReady = false;
          currentUid = null;
          showLogin();
          return;
        }

        // —é–∑–µ—Ä —î –ª–æ–∫–∞–ª—å–Ω–æ (–∞–±–æ –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É, –∞–±–æ –ø—ñ—Å–ª—è reload)
        currentUid = user.uid;
        lastUserActionTs = Date.now();

        showLoading(); // —Å–ø–æ—á–∞—Ç–∫—É –ª–æ–∞–¥–µ—Ä, –±–µ–∑ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ

        let sessionResp;
        try {
          sessionResp = await callAcquireSession({ resume: true });
        } catch (err) {
          console.warn("acquireSessionIfFree error:", err);
          // –º–µ—Ä–µ–∂–∞/—Å–µ—Ä–≤–µ—Ä –≤–ø–∞–ª–∏ ‚Üí –±–µ–∑–ø–µ—á–Ω–æ —Å–∫–∏–Ω—å —É login
          elMsg.textContent = "–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ—Å—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.";
          try {
            await auth.signOut();
          } catch (_) {}
          appReady = false;
          currentUid = null;
          showLogin();
          return;
        }

        if (!sessionResp || !sessionResp.ok) {
          // —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–µ "–Ω—ñ, —Å–µ—Å—ñ—è –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞ —ñ–Ω—à–∏–º clientId"
          elMsg.textContent =
            "–¶–µ–π –∞–∫–∞—É–Ω—Ç —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∏–π –Ω–∞ —ñ–Ω—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó. –°–ø–µ—Ä—à—É –≤–∏–π–¥—ñ—Ç—å —Ç–∞–º.";
          try {
            await auth.signOut();
          } catch (_) {}
          appReady = false;
          currentUid = null;
          showLogin();
          return;
        }

        // –≤—Å–µ –æ–∫, —Ü—è –≤–∫–ª–∞–¥–∫–∞/–¥–µ–≤–∞–π—Å –º–∞—î –ø—Ä–∞–≤–æ –∂–∏—Ç–∏
        appReady = true;
        showApp(user.email);
        bootDataUI();
        startHeartbeatLoop();
        startIdleLogoutWatch();
      });

      // ================== LOGIN FORM ==================
      elForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        elMsg.textContent = "";

        const email = document.getElementById("email").value.trim();
        const pass = document.getElementById("password").value;

        showLoading(); // –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∑—É—î–º–æ "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶"

        try {
          await auth.signInWithEmailAndPassword(email, pass);
          // –¥–∞–ª—ñ onAuthStateChanged –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å
        } catch (err) {
          console.warn("login error:", err);
          const code = err?.code || "";
          if (code === "auth/invalid-login-credentials") {
            elMsg.textContent = "–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å.";
          } else if (code === "auth/too-many-requests") {
            elMsg.textContent = "–ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.";
          } else {
            elMsg.textContent = "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.";
          }
          showLogin(); // –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –ª–æ–≥—ñ–Ω—É
        }
      });

      // ================== MANUAL LOG OUT BUTTON ==================
      elOut.addEventListener("click", async () => {
        await logoutAndRelease({ viaBeacon: false });
      });
    </script>
  </body>
</html>
