<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imbalance Monitor</title>
  <style>
    :root {
  --bg: #f4f4f4;
  --text: #000;
  --table-bg: #fff;
  --header-bg: #ccc;
  --alert-text: red;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}

/* –í–µ—Ä—Ö–Ω—ñ–π –±–ª–æ–∫ */
.controls {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  align-items: center;
  padding: 1rem;
}

h1, h2 {
  margin: 0.3rem 0;
}

button {
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—å */
.tables {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: calc(100vh - 100px); /* 100px = –≤–∏—Å–æ—Ç–∞ controls + –≤—ñ–¥—Å—Ç—É–ø */
  padding: 0 1rem 1rem 1rem;
  box-sizing: border-box;
}

@media (min-width: 900px) {
  .tables {
    flex-direction: row;
  }
}

/* –ë–ª–æ–∫ –æ–∫—Ä–µ–º–æ—ó —Ç–∞–±–ª–∏—Ü—ñ */
.table-container {
  flex: 1;
  background: var(--table-bg);
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  border: 2px solid var(--header-bg);
  position: relative;
  height: 100%;
}

.table-container h2 {
  position: sticky;
  top: 0;
  background: var(--table-bg);
  z-index: 2;
  padding: 4px 0;
  margin: 0;
  font-size: 1.2rem;
  color: green;
}

.table-container#sell h2 {
  color: red;
}

/* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ª–∏—à–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—å */
.table-content {
  flex-grow: 1;
  overflow-y: auto;
}

/* –¢–∞–±–ª–∏—Ü—è */
table {
  border-collapse: collapse;
  width: 100%;
  min-width: 600px;
}

th, td {
  border: 2px solid var(--header-bg);
  padding: 8px;
  text-align: center;
}

th {
  background: var(--header-bg);
  cursor: pointer;
  position: sticky;
  top: 0;
  z-index: 1;
}

/* –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ —É–º–æ–≤–Ω–∞ */
tr.high-imbalance td {
  color: var(--alert-text);
  font-weight: bold;
}

tr.dashed-symbol td {
  color: var(--alert-text);
  font-weight: bold;
}

.archive-row.hidden {
  display: none;
}

/* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
[data-theme="dark"] {
  --bg: #111;
  --text: #fff;
  --table-bg: #222;
  --header-bg: #333;
  --alert-text: lightcoral;
}
  </style>
</head>
<body>
  <div class="controls">
    <h1>üìä Imbalance Monitor</h1>
    <button onclick="toggleTheme()">üåì –ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É</button>
  </div>

  <div class="tables">
    <div class="table-container" id="buy">
      <h2>Buy Imbalance (<span id="buy-count">0</span>)</h2>
      <div class="table-content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
    <div class="table-container" id="sell">
      <h2>Sell Imbalance (<span id="sell-count">0</span>)</h2>
      <div class="table-content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
  </div>

  <script>
  let theme = localStorage.getItem("theme") || "light";

  function applyTheme() {
    const root = document.documentElement;
    root.setAttribute("data-theme", theme);
    if (theme === "dark") {
      root.style.setProperty('--bg', '#111');
      root.style.setProperty('--text', '#fff');
      root.style.setProperty('--table-bg', '#222');
      root.style.setProperty('--header-bg', '#333');
    } else {
      root.style.setProperty('--bg', '#f4f4f4');
      root.style.setProperty('--text', '#000');
      root.style.setProperty('--table-bg', '#fff');
      root.style.setProperty('--header-bg', '#ccc');
    }
  }

  function toggleTheme() {
    theme = theme === "dark" ? "light" : "dark";
    localStorage.setItem("theme", theme);
    applyTheme();
  }

  const sortStates = {};

  function sortTable(table, colIndex, forceDesc = null) {
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .filter(r => !r.classList.contains("archive-row") && !r.closest(".archive-table"));

    const tableId = table.closest(".table-container")?.id || "default";
    if (!sortStates[tableId]) sortStates[tableId] = {};
    const desc = forceDesc !== null ? forceDesc : !(sortStates[tableId][colIndex] || false);
    sortStates[tableId][colIndex] = desc;

    rows.sort((a, b) => {
      const aVal = parseFloat(a.children[colIndex].innerText.replace(/[^0-9.\-]/g, '')) || 0;
      const bVal = parseFloat(b.children[colIndex].innerText.replace(/[^0-9.\-]/g, '')) || 0;
      return desc ? bVal - aVal : aVal - bVal;
    });

    rows.forEach(row => {
      const archiveRow = row.nextElementSibling?.classList.contains("archive-row") ? row.nextElementSibling : null;
      tbody.appendChild(row);
      if (archiveRow) tbody.appendChild(archiveRow);
    });
  }

  async function loadTable(json, id) {
    const res = await fetch(json + '?t=' + new Date().getTime());
    const data = await res.json();
    const container = document.querySelector(`#${id} .table-content`);
    if (!data.main || data.main.length === 0) {
      container.innerText = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
      return;
    }
    // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∞–∫—Ü—ñ–π
if (id === "buy") {
  document.getElementById("buy-count").textContent = data.main.length - 1;
}
if (id === "sell") {
  document.getElementById("sell-count").textContent = data.main.length - 1;
}

    let html = "<table><thead><tr>";
    data.main[0].forEach((cell, i) => {
      html += `<th onclick="sortTable(this.closest('table'), ${i})">${cell}</th>`;
    });
    html += "</tr></thead><tbody>";
    for (let i = 1; i < data.main.length; i++) {
      const row = data.main[i];
      const symbol = row[1];
      const percent = parseFloat(row[row.length - 1].replace('%','')) || 0;
      const classes = [
        "expand-row",
        percent > 90 ? "high-imbalance" : "",
        symbol.includes("-") ? "dashed-symbol" : ""
      ].join(" ").trim();

      html += `<tr class="${classes}" data-symbol="${symbol}">`;
      row.forEach((cell, idx) => {
        const formatted = (idx >= 2 && idx <= 4 && !isNaN(cell)) ? Number(cell).toLocaleString() : cell;
        html += `<td>${formatted}</td>`;
      });
      html += "</tr>";

      if (data.archive && data.archive[symbol]) {
        html += `<tr class="archive-row hidden"><td colspan="${row.length}"><table class="archive-table"><thead><tr>`;
        html += data.archive[symbol][0].map(c => `<th>${c}</th>`).join('');
        html += "</tr></thead><tbody>";
        data.archive[symbol].slice(1).forEach(r => {
  html += "<tr>";
  r.forEach((c, idx) => {
    const formatted = (idx >= 1 && !isNaN(c)) ? Number(c).toLocaleString() : c;
    html += `<td>${formatted}</td>`;
  });
  html += "</tr>";
});
        html += "</tbody></table></td></tr>";
      }
    }
    html += "</tbody></table>";
    container.innerHTML = html;

    // –î–æ–¥–∞—î–º–æ –ø–æ–¥—ñ—ó –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É
    document.querySelectorAll(`#${id} .expand-row`).forEach(row => {
  row.addEventListener('click', (e) => {
    const clickedCellIndex = Array.from(row.children).indexOf(e.target);
    if (clickedCellIndex === 1) return; // –Ø–∫—â–æ –∫–ª—ñ–∫–∞—î–º–æ –ø–æ Symbol ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ

    const next = row.nextElementSibling;
    if (next && next.classList.contains("archive-row")) {
      next.classList.toggle("hidden");
      row.classList.toggle("expanded");
    }
  });
});

    // –ê–≤—Ç–æ—Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ –∫–æ–ª–æ–Ω—Ü—ñ % ImbADV
    const table = container.querySelector("table");
    const lastColIndex = data.main[0].length - 1;
    sortTable(table, lastColIndex, true);
  }

  function loadAll() {
    loadTable("buy_data.json", "buy");
    loadTable("sell_data.json", "sell");
  }

  applyTheme();
  loadAll();
  setInterval(loadAll, 90000);
</script>
</body>
</html>
